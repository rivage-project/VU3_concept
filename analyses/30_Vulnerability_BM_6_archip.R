# Calculate final vulnerability

# clean working environment
rm(list=ls())
#load the only attached package
library(ggplot2)

###### create data frame with all markers ######

# all paths are linked to the project architecture
# root folder is VU3_concept

# load exposure to each threat
ias <- readRDS("data/derived-data/22_IAS_exposure_45_isl.rds")
cc <- readRDS("data/derived-data/21_CC_SED_exposure_45_isl.rds")
lu <- readRDS("data/derived-data/20_LU_exposure_45_isl.rds")

# combine all markers in threats
threats <- dplyr::left_join(
  lu |> dplyr::select(ID, med_HM_change, rdens_osm) |>
    dplyr::mutate(ID = as.integer(ID)),
  dplyr::left_join(
    cc |> dplyr::select(ID, sed_tot_med, sed_pr_isl_med, sed_tas_isl_med), 
    ias |> dplyr::select(ID, nb_alien, alien_vert_cover)
  )
)

# change for median
ggplot(lu)+geom_point(aes(x=mean_HM_change, y = med_HM_change))
hist(lu$mean_HM_change)
hist(lu$med_HM_change)


# load traits and occurrences of birds and mammals on the 45 islands
# for the sensitivity
traits <- readRDS("data/derived-data/05_traits_BM_45_isl.rds")
# add Class information
tr_birds <- readRDS("data/derived-data/04_Bird_traits.RDS")
traits <- traits |>
  dplyr::mutate(Class = ifelse(sci_name %in% tr_birds$scientificName, "Aves", "Mammalia"))


# load ac markers (abiotic, biotic for species, biotic for communities)
ac_a <- readRDS("data/derived-data/10_abiotic_AC_45_isl.rds")
ac_b_com <- readRDS("data/derived-data/11_Biotic_AC_BM_community.rds")
ac_b_sp <- readRDS("data/derived-data/11_Biotic_AC_BM_species.rds")


# combine all E, S, and AC markers

data_all <- dplyr::left_join(
  dplyr::left_join(ac_a, threats),
  dplyr::left_join(traits, ac_b_sp, by = "sci_name", relationship = "many-to-many"),
  by = "ID", relationship = "many-to-many") |> 
  dplyr::left_join(ac_b_com, by = "ID", relationship = "many-to-many") 


sum(is.na(data_all))

saveRDS(data_all, "outputs/30_all_VU_components_45_isl_266_BM_sp.rds")
openxlsx::write.xlsx(data_all, "outputs/30_all_VU_components_45_isl_266_BM_sp.xlsx")

########### Calculate VU #############

# source functions
source("R/Calculate_components_VU_FUN.R")

# load data in final format
data_all <- readRDS("outputs/30_all_VU_components_45_isl_266_BM_sp.rds")
# load island information and polygons
isl <- readRDS("data/derived-data/01_shp_45_major_isl_clean.rds")


# number of birds and mammals per archipelago
# for table 1
data_all |> dplyr::distinct(Archip, sci_name, Class) |>
  dplyr::group_by(Archip, Class)|>
  dplyr::count()

# Calculate VU per species per island

VU_sp_isl <- vulnerabilityFUN(data_all)

# join VU data with island information
VU_sp_isl_info <- dplyr::left_join(
  isl |> sf::st_drop_geometry() |> dplyr::select(ID, Archip, Island),
  VU_sp_isl
)

# create a ranking to make sure islands of each archipelago are together in the graph
arch_isl <- paste0(isl$Archip, isl$Island)
archip_order <- isl$Island[match(sort(arch_isl), arch_isl)] |> unique() 
VU_sp_isl_info$Island <- factor(VU_sp_isl_info$Island, levels = archip_order)

# calculate mean, median and sd value per island
VU_median_mean <- 
  VU_sp_isl_info |> 
  dplyr::group_by(Archip, Island) |> 
  dplyr::summarise(
    Median = median(VU),
    Mean = mean(VU),
    SD = sd(VU)) |> dplyr::ungroup()
isl_order <- VU_median_mean$Island[match(sort(VU_median_mean$Mean), VU_median_mean$Mean)]
VU_median_mean$Island_order <- factor(VU_median_mean$Island, levels = isl_order)
VU_sp_isl_info$Island_order <- factor(VU_sp_isl_info$Island, levels = isl_order)


# Dive into components

# get exposure
E_all <- exposureFUN(data_all)
# bind with island area
E_area <- isl |> 
  dplyr::mutate(Area = sf::st_area(geometry))|>
  dplyr::mutate(Area_km2 = units::drop_units(Area)/1000000)|>
  sf::st_as_sf() |> sf::st_drop_geometry() |>
  dplyr::select(ID, Archip, Area_km2)|>
  dplyr::left_join(E_all, by ="ID")

# get sensitivity
S_all <- sensitivityFUN(data_all)

# get AC (sum of biotic and abiotic)
AC_all <- adaptive_capacityFUN(data_all)


# Combine all markers 
metrics <- VU_sp_isl_info |> dplyr::select(ID, Archip, sci_name, VU) |>
  # add exposure metrics
  dplyr::left_join(E_all |> dplyr::select(ID, med_HM_change:alien_vert_cover), by ="ID") |> 
  # add sensitivity metrics
  dplyr::left_join(S_all |> # invert the 'generalist' variables to 'specialist' ones
                     dplyr::mutate(AoH_specialist = 1-aoh_km2,
                                   Diet_specialist = 1-nb_diet,
                                   Habitat_specialist = 1-nb_hab)|>
                     dplyr::select(sci_name, gen_length_y, AoH_specialist:Habitat_specialist), 
                   by ="sci_name") |>
  # add ac metrics
  dplyr::left_join(AC_all |> dplyr::select(ID, sci_name, dispersal, fred, Area, max_elev, med_tri, PA_prop), 
                   by =c("ID", "sci_name")) |> 
  dplyr::group_by(Archip, ID) |>
  dplyr::summarise_if(is.numeric, mean) |> dplyr::ungroup()


compo <- VU_sp_isl_info |> dplyr::select(ID, Archip, sci_name, VU) |>
  # add exposure metrics
  dplyr::left_join(E_all |> dplyr::select(ID, lu, cc, ias, exposure), by ="ID") |> 
  # add sensitivity metrics
  dplyr::left_join(S_all |> dplyr::select(sci_name, sensitivity), by ="sci_name") |>
  # add ac metrics
  dplyr::left_join(AC_all |> dplyr::select(ID, sci_name, ac_abiotic, ac_biotic, adaptive_capacity), 
                   by =c("ID", "sci_name")) |> 
  dplyr::group_by(Archip, ID) |>
  dplyr::summarise_if(is.numeric, mean) |> dplyr::ungroup()

########## Plot the final figures #############


library(ggplot2)

# set colors
archip_col <-  c(
  "Galapagos Islands" = "#33A02C",
  "Canary Islands" = "#1F78B4",
  "Azores"="#FF7F00", 
  "Mascarene Islands" = "#6A3D9A",
  "Hawaii" = "#E31A1C",
  "Tristan da Cunha Islands" = "#B15928")
"#A6CEE3" "#1F78B4" "#B2DF8A" "#33A02C" "#FB9A99" "#E31A1C" "#FDBF6F" "#FF7F00" "#CAB2D6"
[10] "#6A3D9A" "#FFFF99" "#B15928"
"#66C2A5" "#FC8D62" "#8DA0CB" "#E78AC3" "#A6D854" "#FFD92F"
"#66C2A5" "#FC8D62" "#8DA0CB" "#E78AC3" "#A6D854" "#FFD92F" "#E5C494" "#B3B3B3"
"#1B9E77" "#D95F02" "#7570B3" "#E7298A" "#66A61E" "#E6AB02" "#A6761D" "#666666"
archip_col1 <-  c(
  "Galapagos Islands" = "#66A61E",
  "Canary Islands" = "#7570B3",
  "Azores"="#1B9E77", 
  "Mascarene Islands" = "#D95F02",
  "Hawaii" = "#E7298A",
  "Tristan da Cunha Islands" = "#A6761D")

viridis::inferno(n=7)
"#000004FF" "#420A68FF" "#932667FF" "#DD513AFF" "#FCA50AFF" "#FCFFA4FF"
"#000004FF" "#330A5FFF" "#781C6DFF" "#BB3754FF" "#ED6925FF" "#FCB519FF" "#FCFFA4FF"

archip_col1 <-  c(
  "Galapagos Islands" = "#BB3754FF",
  "Canary Islands" = "#781C6DFF",
  "Azores"="#ED6925FF", 
  "Mascarene Islands" = "#000004FF",
  "Hawaii" = "#330A5FFF",
  "Tristan da Cunha Islands" = "#FCB519FF")

library(RColorBrewer)
display.brewer.all(colorblindFriendly = T)
RColorBrewer::brewer.pal(12, "Paired")
RColorBrewer::brewer.pal(6, "Set2")
RColorBrewer::brewer.pal(8, "Dark2")

#### Fig 1 - Schematic workflow of Methods #####
# Done manually in ppt, need only to plot the map

world <- map_data("world")

pdf("figures/world.pdf")
ggplot(world)+
  geom_map(data = world, map = world,
           aes(long, lat, map_id = region),
           color = NA, fill = "grey70") + theme_void()
dev.off()

#### Fig 2 - VUlnerability ranking for the 45 islands ####

fig2 <- ggplot() +
  geom_point(data = VU_sp_isl_info, aes(x = VU, y = Island_order),
             col = "grey", alpha = .2)+
  geom_point(data = as.data.frame(VU_median_mean), 
             aes(x=Mean, y=Island, col=Archip, pch = Archip), size = 2) +
  geom_errorbar(data = as.data.frame(VU_median_mean), 
                aes(x=Mean, xmin=Mean-SD, xmax=Mean+SD, y=Island_order, col=Archip)) +
  theme_bw() +
  xlab('Vulnerability per species per island (mean +/- SD)') +
  scale_color_manual("Archipelago", values = archip_col1, labels = c(
    "Azores","Canaries","Galapagos","Hawai‘i","Mascarenes","Tristan da Cunha")) +
  theme(legend.position = "right") +
  ylab('Island name')

pdf("figures/30_fig2_mean_VU_per_isl.pdf", 8,7)
fig2
dev.off()



LM <- lm(Mean~Archip, VU_median_mean)
par(mfrow = c(2,2))
plot(LM)
anova(LM)
LM

summary(LM)
coef(LM)+0.96274604


# significant effect of Archip on final VU value
av <- aov(Mean~Archip, VU_median_mean)
summary(av)
TukeyHSD(av) 



#### Fig 3 - Metric values for each island - Parallel plots ####

# function for plotting parallel plots 
plot.par.coord <- function(metrics){
  GGally::ggparcoord(data = metrics,
                     columns = 4:ncol(metrics), 
                     scale="globalminmax",
                     groupColumn = 3, 
                     showPoints = TRUE,
                     order = c(4:ncol(metrics)),
                     alphaLines = 0.3) +
    viridis::scale_color_viridis()+
    theme_bw()+
    facet_wrap(~Archip, nrow = 3, ncol = 2)+
    theme(axis.text.x = element_text(angle = 90),
          #legend.position = "none",
          strip.background = element_rect(colour="grey30",fill= NA))+
    labs(facet=unique(metrics$Archip))
}

# new names for metrics
newnames <- c("Archip","ID", "VU", "E_LU_modif_change", "E_LU_road_density", "E_CC_temp_precip", "E_BI_alien_richness", "E_BI_alien_cover", "S_generation_length", "S_AoH_specialist", "S_Diet_spe", "S_habitat_spe", "ACb_dispersal_ability", "ACb_funct_redundancy", "ACa_area", "ACa_elevation","ACa_terrain_ruggedness", "ACa_protected_areas")

names(metrics) = newnames

plot.par.coord(metrics)

pdf("figures/31_parallel_plot.pdf",8,6)
plot.par.coord(metrics)
dev.off()

# to complete with inskape for adding the colors in x axis labels + 
# moving the color gradient for VU + labeling facets

#### Fig 4 - Relationships between threats ####

# first paramatric tests => need to check assumptions
# cor.test(E_area$lu, E_area$cc, method = "spearman")
# cor.test(E_area$ias, E_area$cc, method = "spearman")
# cor.test(E_area$ias, E_area$lu, method = "spearman")

# test the assumptions
LM <- lm(lu~cc, data = E_area)
LM <- lm(ias~cc, data = E_area)
LM <- lm(ias~lu, data = E_area)
summary(LM)
par(mfrow = c(2,2))
plot(LM) # they are not met

# use non parametric tests
cor.test(E_area$lu, E_area$cc, method = "kendall")
cor.test(E_area$cc, E_area$lu, method = "kendall")

cor.test(E_area$lu, E_area$ias, method = "spearman")
cor.test(E_area$cc, E_area$ias, method = "spearman")

# lu and cc
lc <- ggplot(E_area)+
  geom_hline(yintercept = .5, lty = 2, color = "grey")+
  geom_vline(xintercept = .5, lty = 2, color = "grey")+
  geom_point(aes(x=lu, y = cc, size = Area_km2, color = Archip), 
             position = 'jitter', alpha = .6)+
  xlab("Land-use change")+ylab("Climate change")+
  scale_color_manual("Archipelago", values = archip_col1, labels = c(
    "Azores","Canary","Galapagos","Hawai‘i","Mascarenes","Tristan da Cunha"))+
  ggpubr::stat_cor(aes(x=lu, y = cc), method = "kendall", cor.coef.name = "tau", 
                   p.accuracy = 0.001, r.accuracy = 0.001, label.x = 0.55)+
  theme_bw()
lc


# lu and ias
li <- ggplot(E_area)+
  geom_hline(yintercept = .5, lty = 2, color = "grey")+
  geom_vline(xintercept = .5, lty = 2, color = "grey")+
  geom_point(aes(x=lu, y = ias, size = Area_km2, color = Archip), 
             position = 'jitter', alpha = .5)+
  xlab("Land-use change")+ylab("Biological invasions")+
  scale_color_manual("Archipelago", values = archip_col1, labels = c(
    "Azores","Canary","Galapagos","Hawai‘i","Mascarenes","Tristan da Cunha"))+
  ggpubr::stat_cor(aes(x=lu, y = ias), method = "kendall", cor.coef.name = "tau", 
                   p.accuracy = 0.001, r.accuracy = 0.001)+
  theme_bw()
# cc and ias
ci <- ggplot(E_area)+
  geom_hline(yintercept = .5, lty = 2, color = "grey")+
  geom_vline(xintercept = .5, lty = 2, color = "grey")+
  geom_point(aes(x=ias, y = cc, size = Area_km2, color = Archip), 
             position = 'jitter', alpha = .5)+
  xlab("Biological invasions")+ylab("Climate change")+
  scale_color_manual("Archipelago", values = archip_col1, labels = c(
    "Azores","Canary","Galapagos","Hawai‘i","Mascarenes","Tristan da Cunha"))+
  ggpubr::stat_cor(aes(x=ias, y = cc),  method = "kendall", cor.coef.name = "tau", 
                   p.accuracy = 0.001, r.accuracy = 0.001)+
  theme_bw()


pdf("figures/30_Relationship_threats.pdf", 6, 6)
ggpubr::ggarrange(lc, li, ci, nrow=2, ncol = 2, legend = "none")
dev.off()
pdf("figures/30_Relationship_threats_legend.pdf", 6, 8)
ggpubr::ggarrange(lc, li, ci, nrow=3, ncol = 1,
                  common.legend=T, legend = "right")
dev.off()


lc
li
ci



#### Supplementary figures ####

# Plot distribution of VU values within each island 

png("figures/30_SupplFig_Vu_distrib_isl.png",
    height = 15, width = 18, units = "cm", res=300 )

ggplot(VU_sp_isl_info, aes(VU)) +
  geom_histogram(aes(fill=Archip), col= NA, bins = 15) +
  scale_fill_manual(values = archip_col1) +
  facet_wrap(~Island) +  
  geom_segment(data=VU_median_mean,
               aes(x = Median, xend=Median, y=0, yend=20), col='gold3', lty = 1, linewidth = .7) +
  geom_segment(data=VU_median_mean,
               aes(x = Mean, xend=Mean, y=0, yend=20), col='grey15', lty = 2, linewidth = .5) +
  theme_bw() + ylab("Number of species")+ xlab("Vulnerability value")+
  theme(legend.position = "none")


dev.off()



# VU per island function of latitude and longitude

shp_vu <- dplyr::left_join(isl, VU_median_mean)|> sf::st_as_sf()

ggplot(shp_vu)+
  geom_vline(xintercept = 0, color = "grey20", lty=2)+
  geom_point(aes(x=abs(Lat), y = Mean, col = Archip))+
  scale_color_manual("Archipelago", values = archip_col, labels = c(
    "Azores","Canary","Galapagos","Hawai‘i","Mascarenes","Tristan da Cunha"))+
  theme_bw()+ xlab("Absolute latitude") + ylab("Vulnerability")

ggplot(shp_vu)+
  #geom_vline(xintercept = 0, color = "grey20", lty=2)+
  geom_point(aes(x=Long, y = Mean, col = Archip))+
  scale_color_manual("Archipelago", values = archip_col, labels = c(
    "Azores","Canary","Galapagos","Hawai‘i","Mascarenes","Tristan da Cunha"))+
  theme_bw()+ xlab("Longitude") + ylab("Vulnerability")


# Correlation between E markers

E_markers_corr <- cor(E_all |> dplyr::select(-c(ID, lu, cc, ias)))
corrplot::corrplot(E_markers_corr, method = "number")

E_all_corr <- cor(E_all[,c("exposure", "lu", "cc", "ias")])
corrplot::corrplot(E_all_corr, method = "number")

ias <- ggplot(E_all)+
  geom_histogram(aes(x = ias), bins = 10, fill = "green4", col = NA)+
  xlab("Biological invasions value")+
  ylab("Number of islands") + theme_bw()
lu <- ggplot(E_all)+
  geom_histogram(aes(x = lu), bins = 10, fill = "blue3", col = NA)+
  xlab("Land-use change value")+
  ylab("Number of islands") + theme_bw()
cc <- ggplot(E_all)+
  geom_histogram(aes(x = cc), bins = 10, fill = "red3", col = NA)+
  xlab("Climate change value")+
  ylab("Number of islands") + theme_bw()
exp <- ggplot(E_all)+
  geom_histogram(aes(x = exposure), bins = 10, fill = "grey30", col = NA)+
  xlab("Exposure value")+
  ylab("Number of islands") + theme_bw()

ggpubr::ggarrange(ias, lu, cc, exp, nrow=2, ncol = 2)


# Correlation between S markers
S_markers_corr <- cor(S_all |> dplyr::select(-sci_name))
corrplot::corrplot(S_markers_corr, method = "number")

# Correlation between AC markers
AC_markers_corr <- cor(AC_all |> dplyr::select(-c(sci_name, ID)))
corrplot::corrplot(AC_markers_corr, method = "circle")




# relationships between components


es <- ggplot(compo)+
  geom_point(aes(x=exposure, y = sensitivity, color = Archip))+
  scale_color_manual("Archipelago", values = archip_col, labels = c(
    "Azores","Canaries","Galapagos","Hawai‘i","Mascarenes","Tristan da Cunha"))+
  ggpubr::stat_cor(aes(x = exposure, y = sensitivity), method = "kendall",
                   p.accuracy = 0.001, r.accuracy = 0.001, cor.coef.name = "tau")+
  theme_bw()+ xlab("Exposure") + ylab("Sensitivity")
es
cor.test(compo$exposure, compo$sensitivity, method = "spearman")
cor.test(compo$exposure, compo$sensitivity, method = "kendall")


eac <- ggplot(compo)+
  geom_point(aes(x=exposure, y = adaptive_capacity, color = Archip))+
  scale_color_manual("Archipelago", values = archip_col, labels = c(
    "Azores","Canaries","Galapagos","Hawai‘i","Mascarenes","Tristan da Cunha"))+
  ggpubr::stat_cor(aes(x = exposure, y = adaptive_capacity), method = "kendall",
                   p.accuracy = 0.001, r.accuracy = 0.001, cor.coef.name = "tau")+
  theme_bw()+ xlab("Exposure") + ylab("Adaptive capacity")
eac
cor.test(compo$exposure, compo$adaptive_capacity, method = "kendall")
cor.test(compo$exposure, compo$ac_abiotic, method = "kendall")
cor.test(compo$exposure, compo$ac_biotic, method = "kendall")


sac <- ggplot(compo)+
  geom_point(aes(x=sensitivity, y = adaptive_capacity, color = Archip))+
  scale_color_manual("Archipelago", values = archip_col, labels = c(
    "Azores","Canaries","Galapagos","Hawai‘i","Mascarenes","Tristan da Cunha"))+
#  geom_smooth(aes(x=sensitivity, y = adaptive_capacity), method="lm")+
  ggpubr::stat_cor(aes(x = sensitivity, y = adaptive_capacity), method = "kendall",
                   p.accuracy = 0.001, r.accuracy = 0.001, cor.coef.name = "tau")+
  theme_bw()+ xlab("Sensitivity") + ylab("Adaptive capacity")
sac
cor.test(compo$sensitivity, compo$adaptive_capacity)
plot(lm(sensitivity~adaptive_capacity, data = compo))

cor.test(compo$sensitivity, compo$ac_abiotic)
cor.test(compo$sensitivity, compo$ac_biotic)

ggplot(compo)+
  geom_point(aes(x=sensitivity, y = ac_biotic, color = Archip))+
  scale_color_manual("Archipelago", values = archip_col, labels = c(
    "Azores","Canaries","Galapagos","Hawai‘i","Mascarenes","Tristan da Cunha"))+
  theme_bw()+
  geom_smooth(aes(x=sensitivity, y = ac_biotic), method="lm")+
  ggpubr::stat_cor(aes(x=sensitivity, y = ac_biotic), method = "spearman",
                   p.accuracy = 0.001, r.accuracy = 0.01)

cor.test(compo$ac_biotic, compo$ac_abiotic, method = "kendall")


png("figures/30_SupplFig_relationship_components.png", 
    height = 15, width = 15, units = "cm", res=300)
ggpubr::ggarrange(es, eac, sac, ncol = 2, nrow = 2, common.legend = T, legend = "bottom")
dev.off()



# archipelago effect on final VU

png("figures/30_SupplFig_Vu_archip.png", 
    height = 10, width = 15, units = "cm", res=300)
ggplot(VU_sp_isl_info)+
  geom_point(aes(x=Archip, y = VU, color=Archip), position = "jitter", alpha = .5)+
  geom_boxplot(aes(x=Archip, y = VU), fill = NA)+
  scale_color_manual("Archipelago", values = archip_col, guide = "none")+
  scale_x_discrete(labels = c(
    "Azores","Canaries","Galapagos","Hawai‘i","Mascarenes","Tristan da Cunha"))+
  ylab("Vulnerability per species per island")+
  theme_bw()+
  theme(axis.title.x=element_blank())
dev.off()
  

### test mixed effect 

LM <- lm(VU~Archip, VU_sp_isl_info)
summary(LM)
par(mfrow = c(2,2))
plot(LM)


av <- aov(VU~Archip, VU_sp_isl_info)
#plot(av)
anova(av)
# significant effect of Archip on final VU value
TukeyHSD(av)


# model with species as mixed effect
mod <- lm(VU~Archip, VU_sp_isl_info)

# Test of françois's suggestion
mod <- lme4::lmer(VU~Archip+(1|Island/sci_name), VU_sp_isl_info)
# impossible because our data are per species per island
# there is no duplicated information 

# using only islands
modi <- lme4::lmer(VU~Archip+(1|Island), VU_sp_isl_info)
modi
# same as first model with only archipelagos, because islands are nested within archipelagos

# using only species
# makes sense because some species are on several archipelago
mods <- lme4::lmer(VU~Archip+(1|sci_name), VU_sp_isl_info)
mods
summary(mods)
lme4::fixef(mods)

plot(mods)

#devtools::install_github("goodekat/redres")
par(mfrow = c(1,2))
ggpubr::ggarrange(
  redres::plot_redres(mods), redres::plot_resqq(mods),
  ncol = 2, nrow = 1)

anova(mods, modi)
# best model includes species as random effect but not islands

lme4::ranef(mods)




VU_class <- VU_sp_isl_info |> dplyr::left_join(data_all |> dplyr::select(sci_name, ID, Class))
ggplot(VU_class)+
  geom_point(aes(x=Archip, y = VU, color=Class), position = "jitter", alpha = .5)+
  geom_boxplot(aes(x=Archip, y = VU, color = Class), fill = NA)+
  scale_color_manual("Class", values = c("Aves" = "#51C3CC", "Mammalia"="#ffc44c"))+
  scale_x_discrete(labels = c(
    "Azores","Canary","Galapagos","Hawai‘i","Mascarenes","Tristan da Cunha"))+
  ylab("Vulnerability per species per island")+
  theme_bw()+
  theme(axis.title.x=element_blank())


# how many values per species
1362/266
bm_vu <- data_all |> dplyr::group_by(sci_name)|>
  dplyr::count()
summary(bm_vu)







######## Draft -- Bootstrap on VU values ###########

# vulnerability
VU_sp_isl <- vulnerabilityFUN(data_all)
VU_isl <- vulnerabilityFUN(data_all, by_island = T)
head(VU_sp_isl)
head(VU_isl)



# load isl info
isl <- readRDS("data/derived-data/01_shp_45_major_isl_clean.rds")

VU_isl_info <- dplyr::left_join(
  isl |> sf::st_drop_geometry() |> dplyr::select(ID, Archip, Island),
  VU_isl
)
VU_sp_isl_info <- dplyr::left_join(
  isl |> sf::st_drop_geometry() |> dplyr::select(ID, Archip, Island),
  VU_sp_isl
)


VU_mam_isl <- vulnerabilityFUN(data_all |> dplyr::filter(Class=="Mammalia"))
VU_bird_isl <- vulnerabilityFUN(data_all |> dplyr::filter(Class=="Aves"))



arch_isl <- paste0(VU_isl_info$Archip, VU_isl_info$Island)
archip_order <- VU_isl_info$Island[match(sort(arch_isl), arch_isl)] |> unique() # This is to make sure the same islands of each archipelago are together in the graph

VU_isl_info$Island <- factor(VU_isl_info$Island, levels = archip_order)
VU_sp_isl_info$Island <- factor(VU_sp_isl_info$Island, levels = archip_order)

VU_median_mean <- 
  VU_sp_isl_info |> 
  dplyr::group_by(Archip, Island) |> 
  dplyr::summarise(
    Median = median(VU),
    Mean = mean(VU),
    SD = sd(VU)) |> dplyr::ungroup()
isl_order <- VU_median_mean$Island[match(sort(VU_median_mean$Mean), VU_median_mean$Mean)]
VU_median_mean$Island_order <- factor(VU_median_mean$Island, levels = isl_order)
VU_sp_isl_info$Island_order <- factor(VU_sp_isl_info$Island, levels = isl_order)



# per species and islands

VU_boot <-
  vulnerabilityFUN(data_all,
                   n_samples = 100,
                   prop_samples = 0.9)

VU_boot_summary <-
  summary_bootstrap(VU_boot)

head(VU_boot_summary)


# per islands

VU_boot_isl <-
  vulnerabilityFUN(data_all,
                   by_island = T,
                   n_samples = 100,
                   prop_samples = 0.9)

VU_boot_summary_isl <-
  summary_bootstrap(VU_boot_isl)

VU_boot_to_plot <- dplyr::left_join(
  VU_isl_info |> dplyr::select(ID, Archip, Island),
  VU_boot_summary_isl)

isl_order_boot <- VU_boot_to_plot$Island[match(sort(VU_boot_to_plot$median_VU), VU_boot_to_plot$median_VU)]
VU_boot_to_plot$Island_order <- factor(VU_boot_to_plot$Island, levels = isl_order_boot)


ggplot(VU_boot_to_plot, aes(x=median_VU,
                                  xmin=lci_VU,
                                  xmax=uci_VU,
                                  y=Island_order, 
                                  col=Archip)) +
  geom_point() +
  geom_errorbar() +
  theme_bw() +
  ggtitle('Vulnerability') +
  xlab('median \u00B1 95% CI') +
  scale_color_manual("Archipelago",
                     values = archip_col) +
  theme(legend.position = "right") +
  ylab('Island name')
