# Calculate final vulnerability

rm(list=ls())


###### create data frame with all markers ######

# all paths are linked to the project architecture
# root folder is VU3_concept

# load exposure to each threat
ias <- readRDS("data/derived-data/22_IAS_exposure_45_isl.rds")
cc <- readRDS("data/derived-data/21_CC_SED_exposure_45_isl.rds")
lu <- readRDS("data/derived-data/20_LU_exposure_45_isl.rds")

# combine all markers in threats
threats <- dplyr::left_join(
  lu |> dplyr::select(ID, mean_HM_change, rdens_osm) |>
    dplyr::mutate(ID = as.integer(ID)),
  dplyr::left_join(
    cc |> dplyr::select(ID, sed_tot_med, sed_pr_isl_med, sed_tas_isl_med), 
    ias |> dplyr::select(ID, nb_alien, alien_vert_cover)
  )
)

# load traits and occurrences of birds and mammals on the 45 islands
# for the sensitivity
traits <- readRDS("data/derived-data/05_traits_BM_45_isl.rds")
# add Class information
tr_birds <- readRDS("data/derived-data/04_Bird_traits.RDS")
traits <- traits |>
  dplyr::mutate(Class = ifelse(sci_name %in% tr_birds$scientificName, "Aves", "Mammalia"))


# load ac markers (abiotic, biotic for species, biotic for communities)
ac_a <- readRDS("data/derived-data/10_abiotic_AC_45_isl.rds")
ac_b_com <- readRDS("data/derived-data/11_Biotic_AC_BM_community.rds")
ac_b_sp <- readRDS("data/derived-data/11_Biotic_AC_BM_species.rds")


# combine all E, S, and AC markers

data_all <- dplyr::left_join(
  dplyr::left_join(ac_a, threats),
  dplyr::left_join(traits, ac_b_sp, by = "sci_name", relationship = "many-to-many"),
  by = "ID", relationship = "many-to-many") |> 
  dplyr::left_join(ac_b_com, by = "ID", relationship = "many-to-many") 


sum(is.na(data_all))

saveRDS(data_all, "outputs/30_all_VU_components_45_isl_266_BM_sp.rds")

########### Calculate VU #############

# source functions
source("R/Calculate_components_VU_FUN.R")

data_all <- readRDS("outputs/30_all_VU_components_45_isl_266_BM_sp.rds")



# get exposure
E_all <- exposureFUN(data_all)

# get sensitivity
S_all <- sensitivityFUN(data_all)

# get AC (sum of biotic and abiotic)

AC_all <- adaptive_capacityFUN(data_all)

# vulnerability
VU_sp_isl <- vulnerabilityFUN(data_all)
VU_isl <- vulnerabilityFUN(data_all, by_island = T)
head(VU_sp_isl)
head(VU_isl)



# load isl info
isl <- readRDS("data/derived-data/01_shp_45_major_isl_clean.rds")

VU_isl_info <- dplyr::left_join(
  isl |> sf::st_drop_geometry() |> dplyr::select(ID, Archip, Island),
  VU_isl
)
VU_sp_isl_info <- dplyr::left_join(
  isl |> sf::st_drop_geometry() |> dplyr::select(ID, Archip, Island),
  VU_sp_isl
)


VU_mam_isl <- vulnerabilityFUN(data_all |> dplyr::filter(Class=="Mammalia"))
VU_bird_isl <- vulnerabilityFUN(data_all |> dplyr::filter(Class=="Aves"))



arch_isl <- paste0(VU_isl_info$Archip, VU_isl_info$Island)
archip_order <- VU_isl_info$Island[match(sort(arch_isl), arch_isl)] |> unique() # This is to make sure the same islands of each archipelago are together in the graph

VU_isl_info$Island <- factor(VU_isl_info$Island, levels = archip_order)
VU_sp_isl_info$Island <- factor(VU_sp_isl_info$Island, levels = archip_order)

VU_median_mean <- 
  VU_sp_isl_info |> 
  dplyr::group_by(Archip, Island) |> 
  dplyr::summarise(
    Median = median(VU),
    Mean = mean(VU),
    SD = sd(VU)) |> dplyr::ungroup()
isl_order <- VU_median_mean$Island[match(sort(VU_median_mean$Mean), VU_median_mean$Mean)]
VU_median_mean$Island_order <- factor(VU_median_mean$Island, levels = isl_order)
VU_sp_isl_info$Island_order <- factor(VU_sp_isl_info$Island, levels = isl_order)

library(ggplot2)

# set colors
archip_col <-  c(
  "Galapagos Islands" = "#4DAF4A",
  "Canary Islands" = "#377EB8",
  "Azores"="#FF7F00", 
  "Mascarene Islands" = "#984EA3",
  "Hawaii" = "#E41A1C",
  "Tristan da Cunha Islands" = "#B15928")

ggplot(VU_sp_isl_info, aes(VU)) +
  geom_histogram(aes(fill=Archip), col= NA) +
  scale_fill_manual(values = archip_col) +
  facet_wrap(~Island) +  
  geom_segment(data=VU_median_mean,
               aes(x = Median, xend=Median, y=0, yend=10), col='black') +
  geom_segment(data=VU_median_mean,
               aes(x = Mean, xend=Mean, y=0, yend=10), col='blue') +
  theme_bw()


str(VU_median_mean)

ggplot() +
  geom_point(data = VU_sp_isl_info, aes(x = VU, y = Island_order),
             col = "grey", alpha = .2)+
  geom_point(data = as.data.frame(VU_median_mean), 
             aes(x=Mean, y=Island, col=Archip), size = 2) +
  geom_errorbar(data = as.data.frame(VU_median_mean), 
                aes(x=Mean, xmin=Mean-SD, xmax=Mean+SD, y=Island_order, col=Archip)) +
  theme_bw() +
  ggtitle('Vulnerability') +
  xlab('Vulnerability per species per island (Mean +/- SD)') +
  scale_color_manual("Archipelago", values = archip_col) +
  theme(legend.position = "bottom") +
  ylab('Island name')






######### Bootstrap on VU values ###########


# per species and islands

VU_boot <-
  vulnerabilityFUN(data_all,
                   n_samples = 100,
                   prop_samples = 0.9)

VU_boot_summary <-
  summary_bootstrap(VU_boot)

head(VU_boot_summary)


# per islands

VU_boot_isl <-
  vulnerabilityFUN(data_all,
                   by_island = T,
                   n_samples = 100,
                   prop_samples = 0.9)

VU_boot_summary_isl <-
  summary_bootstrap(VU_boot_isl)

VU_boot_to_plot <- dplyr::left_join(
  VU_isl_info |> dplyr::select(ID, Archip, Island),
  VU_boot_summary_isl)

isl_order_boot <- VU_boot_to_plot$Island[match(sort(VU_boot_to_plot$median_VU), VU_boot_to_plot$median_VU)]
VU_boot_to_plot$Island_order <- factor(VU_boot_to_plot$Island, levels = isl_order_boot)


ggplot(VU_boot_to_plot, aes(x=median_VU,
                                  xmin=lci_VU,
                                  xmax=uci_VU,
                                  y=Island_order, 
                                  col=Archip)) +
  geom_point() +
  geom_errorbar() +
  theme_bw() +
  ggtitle('Vulnerability') +
  xlab('median \u00B1 95% CI') +
  scale_color_manual("Archipelago",
                     values = archip_col) +
  theme(legend.position = "right") +
  ylab('Island name')
