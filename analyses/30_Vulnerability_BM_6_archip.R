# Calculate final vulnerability
# VU = E + S - (ACa +ACb)

rm(list=ls())


###### create data frame with all markers ######

data_all <- create_df()

# set up the project directory
dir_proj <- here::here()

# load exposure to each threat
ias <- readRDS(paste0(dir_proj, "/data/derived-data/22_IAS_exposure_45_isl.rds"))
cc <- readRDS(paste0(dir_proj, "/data/derived-data/21_CC_SED_exposure_45_isl.rds"))
lu <- readRDS(paste0(dir_proj, "/data/derived-data/20_LU_exposure_45_isl.rds"))

# combine all markers in threats
threats <- dplyr::left_join(
  lu |> dplyr::select(ID, mean_HM_static_2017, mean_HM_change, rdens_osm) |>
    dplyr::mutate(ID = as.integer(ID)),
  dplyr::left_join(
    cc |> dplyr::select(ULM_ID, sed_tot_med), 
    ias |> dplyr::select(ULM_ID,
                          nb_alien_bird, 
                          prop_alien_bird, 
                          alien_bird_cover)
  )
)

# load traits and occurrences of birds and mammals on the 45 islands
# for the sensitivity
traits <- readRDS(paste0(dir_proj, "/data/derived-data/05_traits_BM_45_isl.rds"))

# load ac markers (abiotic, biotic for species, biotic for communities)
ac_a <- readRDS(paste0(dir_proj, "/data/derived-data/10_abiotic_AC_45_isl.rds"))
ac_b_com <- readRDS(paste0(dir_proj, "/data/derived-data/11_Biotic_AC_BM_community.rds"))
ac_b_sp <- readRDS(paste0(dir_proj, "/data/derived-data/11_Biotic_AC_BM_species.rds"))


# combine all E, S, and AC markers

data_birds_all <-
  traits |> 
  dplyr::left_join(threats[!names(threats) %in% c("ISLAND")],
                   by = "ID",
                   relationship = "many-to-many") |> 
  dplyr::left_join(ac_elev,
                   by = "ULM_ID",
                   relationship = "many-to-many") |> 
  dplyr::left_join(ac_PA[!names(ac_PA) %in% c("ISLAND", "ARCHIP","geometry")],
                   by = "ULM_ID",
                   relationship = "many-to-many")

return(data_birds_all[complete.cases(data_birds_all),])



# Calculate VU

# source functions
source("R/Calculate_components_VU_FUN.R")

