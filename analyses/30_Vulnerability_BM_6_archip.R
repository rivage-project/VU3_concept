# Calculate final vulnerability

rm(list=ls())


###### create data frame with all markers ######

# all paths are linked to the project architecture
# root folder is VU3_concept

# load exposure to each threat
ias <- readRDS("data/derived-data/22_IAS_exposure_45_isl.rds")
cc <- readRDS("data/derived-data/21_CC_SED_exposure_45_isl.rds")
lu <- readRDS("data/derived-data/20_LU_exposure_45_isl.rds")

# combine all markers in threats
threats <- dplyr::left_join(
  lu |> dplyr::select(ID, mean_HM_change, rdens_osm) |>
    dplyr::mutate(ID = as.integer(ID)),
  dplyr::left_join(
    cc |> dplyr::select(ID, sed_tot_med, sed_pr_isl_med, sed_tas_isl_med), 
    ias |> dplyr::select(ID, nb_alien, alien_vert_cover)
  )
)

# load traits and occurrences of birds and mammals on the 45 islands
# for the sensitivity
traits <- readRDS("data/derived-data/05_traits_BM_45_isl.rds")
# add Class information
tr_birds <- readRDS("data/derived-data/04_Bird_traits.RDS")
traits <- traits |>
  dplyr::mutate(Class = ifelse(sci_name %in% tr_birds$scientificName, "Aves", "Mammalia"))


# load ac markers (abiotic, biotic for species, biotic for communities)
ac_a <- readRDS("data/derived-data/10_abiotic_AC_45_isl.rds")
ac_b_com <- readRDS("data/derived-data/11_Biotic_AC_BM_community.rds")
ac_b_sp <- readRDS("data/derived-data/11_Biotic_AC_BM_species.rds")


# combine all E, S, and AC markers

data_all <- dplyr::left_join(
  dplyr::left_join(ac_a, threats),
  dplyr::left_join(traits, ac_b_sp, by = "sci_name", relationship = "many-to-many"),
  by = "ID", relationship = "many-to-many") |> 
  dplyr::left_join(ac_b_com, by = "ID", relationship = "many-to-many") 


sum(is.na(data_all))

saveRDS(data_all, "outputs/30_all_VU_components_45_isl_266_BM_sp.rds")

########### Calculate VU #############

# source functions
source("R/Calculate_components_VU_FUN.R")

data_all <- readRDS("outputs/30_all_VU_components_45_isl_266_BM_sp.rds")



# get exposure
E_all <- exposureFUN(data_all)

# get sensitivity
S_all <- sensitivityFUN(data_all)

# get AC (sum of biotic and abiotic)

AC_all <- adaptive_capacityFUN(data_all)

# vulnerability
VU_sp_isl <- vulnerabilityFUN(data_all)
VU_isl <- vulnerabilityFUN(data_all, by_island = T)
head(VU_sp_isl)
head(VU_isl)



# load isl info
isl <- readRDS("data/derived-data/01_shp_45_major_isl.rds")

VU_isl_info <- dplyr::left_join(
  isl |> sf::st_drop_geometry() |> dplyr::select(ID, Archip, Island),
  VU_isl
)



VU_mam_isl <- vulnerabilityFUN(data_all |> dplyr::filter(Class=="Mammalia"), by_island = T)
VU_bird_isl <- vulnerabilityFUN(data_all |> dplyr::filter(Class=="Aves"), by_island = T)



######### Bootstrap on VU values ###########


# per species


VU_boot <-
  vulnerabilityFUN(data_all,
                   by_island = TRUE,
                   n_samples = 100,
                   prop_samples = 0.9)


VU_boot_summary <-
  summary_bootstrap(VU_boot)

head(VU_birds_boot_summary)

