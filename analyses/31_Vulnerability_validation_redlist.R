# Get the IUCN trend of species in the checklists
# combine trends at the island level
# Compare with VU at the island level

rm(list=ls())
# set packages 
# install.packages("rredlist")
library(ggplot2)

# setting of the API key to access the IUCN redlist data

api_key <- "0e9cc2da03be72f04b5ddb679f769bc29834a110579ccdbeb54b79c22d3dd53d"

# Get the status trajectory for example species
# rredlist::rl_history(key = api_key, name = "Pyrrhula murina")
# rredlist::rl_search(key = api_key, name = "Chasiempis sandwichensis")$result


###### Load island vulnerability data #####

# load data frame in final format
data_all <- readRDS("outputs/30_all_VU_components_45_isl_266_BM_sp.rds")
# load island information and polygons
# isl <- readRDS("data/derived-data/01_shp_45_major_isl_clean.rds")
# source functions for VU calculation
source("R/Calculate_components_VU_FUN.R")

checklist <- data_all |> dplyr::select(ID:Island, sci_name)
final_vu <- vulnerabilityFUN(data_all, by_island = T)
final_vu_sp <- vulnerabilityFUN(data_all)


# ac <- adaptive_capacityFUN(data_all)

###### Extract IUCN extinction risk for all species ######

iucn_history <- checklist |>
  dplyr::distinct(sci_name) |>
  dplyr::arrange(sci_name) |>
  dplyr::pull(sci_name) |>
  lapply(function(sci_name) {
    rredlist::rl_history(key = api_key, sci_name)$result})

names(iucn_history) <- sort(unique(checklist$sci_name))
for(i in 1:length(iucn_history)){
  iucn_history[[i]]$sp = names(iucn_history)[i]
}

# combine all species into one df
iucn_history_df <- dplyr::bind_rows(iucn_history) |>
  dplyr::select(sp, year, code) |>
  dplyr::mutate(year = as.numeric(year),
                code = as.factor(code)) |>
  dplyr::left_join(status_order, by = "code")

# check the trends for species from one island (Tristan da Cunha)
test <- iucn_history_df |> 
  dplyr::filter(sp %in% (checklist |> dplyr::filter(ID == 7725) |> dplyr::pull(sci_name)))
library(ggplot2)
ggplot(test, aes(year, order, group = sp, color = sp)) + 
  labs(y = "Extinction status level", x = "Time (year)") +
  ylim(0, 6) +
  geom_point() + geom_line()


######## Calculate trend for each island  ########

# Initialization

islands <- final_vu$ID

# Create a table with the list of status and numeric equivalent
status_order <- data.frame(
  code = c("LC","NT","VU","EN","CR","EW","EX","LR/lc","LR/nt","LR/cd","T"),
  order = c(0:6, 0, 1, 3, 3))

# Create a subset data to host results
vul_risk <- data.frame(
  ID = final_vu$ID,
  vu_sum = final_vu$VU,
  count_prop = "NA",
  cum_prop = "NA",
  mean_corr = "NA",
  mean_slope = "NA")

for (i in (1:length(islands))){
  
  # i=1
  island <- islands[i] # select the island
  final_vu$VU[which(final_vu$ID == island)] # Vulnerability value
  # get species list from the island
  sp_isl <- checklist |> dplyr::filter(ID == island) |> dplyr::pull(sci_name)
  # Filter status and years for species from the island  
  status_code <- iucn_history_df |> 
    dplyr::filter(sp %in% sp_isl)
  
  stats <- status_code |>
    # calculate extinction risk statistics
    dplyr::group_by(sp) |>
    dplyr::summarize(first_value = dplyr::first(order)) |>
    dplyr::mutate(n = dplyr::n()) |>
    dplyr::filter(first_value > 1) |>
    dplyr::summarize(sum = sum(first_value),  
            count = dplyr::n(), 
            n = max(n)) |>
    dplyr::mutate(prop = count/n, 
            cum_prop = sum/n)

  vul_risk[which(vul_risk$ID == island), "count_prop"] <- stats$prop
  vul_risk[which(vul_risk$ID == island), "cum_prop"] <- stats$cum_prop
  
  mean_slope <- status_code |>
    dplyr::group_by(sp) |>
    dplyr::group_modify(~ broom::tidy(lm(.x$order ~ .x$year))) |>
    dplyr::filter(term == ".x$year") |>
    dplyr::filter(p.value < 0.05) |>
    dplyr::ungroup() |>
    dplyr::summarize(mean_slope = mean(estimate))
  
  mean_corr <- status_code |>
    dplyr::group_by(sp) |>
    dplyr::group_modify(~ broom::tidy(cor(.x$order, .x$year, method = "spearman"))) |>
    dplyr::filter(x != "NA") |>
    dplyr::ungroup() |>
    dplyr::summarize(mean_corr = mean(x))
  
  vul_risk[which(vul_risk$ID == island), "mean_corr"] <- mean_corr$mean_corr
  vul_risk[which(vul_risk$ID == island), "mean_slope"] <- mean_slope$mean_slope

}

saveRDS(vul_risk, "outputs/31_validation_risk_redlist.rds")

##### Quick and dirty analyses ####

vul_risk <- readRDS("outputs/31_validation_risk_redlist.rds") |>
  dplyr::as_tibble() |>
  dplyr::mutate(count_prop = as.numeric(count_prop)) |>
  dplyr::mutate(cum_prop = as.numeric(cum_prop)) |>
  dplyr::mutate(mean_corr = as.numeric(mean_corr)) |>
  dplyr::mutate(mean_slope = as.numeric(mean_slope)) |> 
  dplyr::left_join(data_all |> dplyr::distinct(ID, Archip, Island))


archip_col <-  c(
  "Galapagos Islands" = "#4DAF4A",
  "Canary Islands" = "#377EB8",
  "Azores"="#FF7F00", 
  "Mascarene Islands" = "#984EA3",
  "Hawaii" = "#E41A1C",
  "Tristan da Cunha Islands" = "#B15928")

ggplot(vul_risk, aes(count_prop, vu_sum, group = Archip, color = Archip)) +
  labs(y = "Vulnerability score", x = "Proportion of threatened species") +
  geom_point()+
  scale_color_manual(values = archip_col)+
  theme_bw()

summary(lm(vu_sum ~ count_prop+Archip, data = vul_risk))

cor(vul_risk$vu_sum, vul_risk$count_prop, use = "complete.obs")


ggplot(vul_risk, aes(mean_corr, vu_sum, group = Archip, color = Archip)) +
  labs(y = "Vulnerability score", x = "Spearman correlation over time") +
  geom_point()+
  scale_color_manual(values = archip_col)+
  theme_bw()

summary(lm(vu_sum ~ mean_corr, data = vul_risk))





####### Simpler method: mean species' extinction probability #######


all_sp <- unique(checklist$sci_name)
# status_trend_df <- data.frame()
# for(i in 1:length(all_sp)){ # takes 5 min
#   status_trend_sp <- rredlist::rl_search(key = api_key, all_sp[i])$result
#   status_trend_df <- dplyr::bind_rows(status_trend_df, status_trend_sp)
#   print(i)
# }
# saveRDS(status_trend_df, "data/raw-data/31_IUCN_status_trend.rds")

status_trend_df <- readRDS("data/raw-data/31_IUCN_status_trend.rds")

summary(as.factor(status_trend_df$population_trend))
summary(as.factor(status_trend_df$category))

status_trend <- status_trend_df |>
  dplyr::rename(sci_name = scientific_name)|>
  dplyr::select(sci_name, class, category, population_trend)

# Give a probability of extinction to each IUCN category (Moers et al 2008)
pCR <- 0.97
proba <- data.frame(category = c("LC", "NT", "VU", "EN", "CR"),
                 p = c(pCR/16, pCR/8, pCR/4, pCR/2, pCR))

# proba per island 

isl_prob <- checklist |>
  dplyr::left_join(status_trend, by ="sci_name") |>
  dplyr::left_join(proba, by = "category")|>
  dplyr::group_by(ID, Archip) |>
  dplyr::summarise(mean_extinct_proba = mean(p, na.rm = T),
                   sd_extinct_proba = sd(p, na.rm = T)) |>
  dplyr::left_join(final_vu, by = "ID") |>
  dplyr::left_join(vul_risk |> dplyr::select(ID, count_prop:mean_slope), by="ID")|>
  dplyr::ungroup()


ggplot(isl_prob, aes(mean_extinct_proba, VU, group = Archip, color = Archip)) +
  labs(y = "Vulnerability score", x = "Mean probability of extinction") +
  geom_point()+
  scale_color_manual(values = archip_col)+
  theme_bw()

summary(lm(VU ~ mean_extinct_proba, data = isl_prob))


ggplot(isl_prob) +
  geom_point(aes(mean_extinct_proba, S, group = Archip, color = Archip))+
  geom_smooth(aes(x=mean_extinct_proba, y=S), color = "grey20", se = T)+
  scale_color_manual(values = archip_col)+
  labs(y = "Sensitivity", x = "Mean probability of extinction") +
  theme_bw()

summary(lm(S ~ mean_extinct_proba, data = isl_prob))

# Monod or Michaelis & Manten model
nlsfit <- nls(S ~ Sm*mean_extinct_proba/(Kp+mean_extinct_proba), data=isl_prob, start=list(Kp=0.5, Sm=0.8))
nlsfit
nlsfit <- nls(S ~ Sm*mean_extinct_proba/(Kp+mean_extinct_proba), data=isl_prob, start=list(Kp=0.6, Sm=0.74))
nlsfit

summary(nlsfit)
coef(nlsfit)
hist(residuals(nlsfit))


xaxis <- seq(from = 0.06, to = max(isl_prob$mean_extinct_proba), length = 255)
yaxis <- predict(nlsfit, newdata = list(mean_extinct_proba = xaxis))

sp <- ggplot() +
  geom_point(data = isl_prob, aes(mean_extinct_proba, S, group = Archip, color = Archip))+
  geom_line(aes(x=xaxis, y = yaxis),  color = "grey20", linewidth = 1)+
  scale_color_manual(values = archip_col)+
  labs(y = "Mean sensitivity", x = "Mean probability of extinction") +
  theme_bw()

shapiro.test(nlsfit$m$resid())
qqnorm(nlsfit$m$resid(), pch = 19)



nlsfit$m$deviance()


scemin <- nlsfit$m$deviance()
n <- nrow(isl_prob)
p <- 2
alpha = 0.05
seuil <- scemin*( 1 + (p*qf(p = 1 - alpha, df1 = p, df2 = n - p))/(n - p) )
Smseq <- seq(from = 0.7, to = 0.98, length = 50)
Kpseq <- seq(from = 0.01, to = 0.1, length = 50 )
scegrid <- matrix(nrow = length(Smseq), ncol = length(Kpseq))
plot(nlsfit$m$getPars()["Sm"], nlsfit$m$getPars()["Kp"], pch = 3,
     xlim = c(0.7, 0.98), ylim = c(0.01, 0.1), las = 1,
     xlab = expression(S[m]),
     ylab = expression(K[p]))
sce <- function(Sm, Kp){
  obs <- isl_prob$S
  theo <- (Sm*isl_prob$mean_extinct_proba)/(Kp + isl_prob$mean_extinct_proba)
  sum((obs - theo)^2)
}
for( i in 1:length(Smseq) ){
  for( j in 1:length(Kpseq)){
    scegrid[i,j] <- sce(Sm = Smseq[i], Kp = Kpseq[j])
    if(scegrid[i,j] > seuil){
      points(Smseq[i],Kpseq[j], pch = 3, cex = 0.5)}}}

contour(x = Smseq,y=Kpseq,z=scegrid, levels= seuil, drawlabels = FALSE,
        xlab = expression(S[m]),
        ylab = expression(K[p]),
        main ="Confidance zone of parameters")
points(nlsfit$m$getPars()["Sm"], nlsfit$m$getPars()["Kp"], pch =3)








ggplot(isl_prob) +
  geom_smooth(aes(x=mean_extinct_proba, y=AC), method = "lm", color = "grey20", se = T)+
  labs(y = "Adaptive capacity", x = "Mean probability of extinction") +
  geom_point(aes(mean_extinct_proba, AC, group = Archip, color = Archip))+
  scale_color_manual(values = archip_col)+
  theme_bw()
summary(lm(AC ~ mean_extinct_proba, data = isl_prob))

ggplot(isl_prob, aes(mean_extinct_proba, E, group = Archip, color = Archip)) +
  labs(y = "Exposure", x = "Mean probability of extinction") +
  geom_point()+
  scale_color_manual(values = archip_col)+
  theme_bw()
summary(lm(S ~ mean_extinct_proba, data = isl_prob))

cor.test(isl_prob$mean_extinct_proba, isl_prob$E)
cor.test(isl_prob$mean_extinct_proba, isl_prob$S)
cor.test(isl_prob$mean_extinct_proba, isl_prob$AC)
cor.test(isl_prob$mean_extinct_proba, isl_prob$VU)


plot(isl_prob$mean_extinct_proba, isl_prob$count_prop)
cor.test(isl_prob$mean_extinct_proba, isl_prob$count_prop)
plot(isl_prob$mean_extinct_proba, isl_prob$cum_prop)
# the two metrics are very similar


plot(isl_prob$mean_extinct_proba, isl_prob$mean_corr)
plot(isl_prob$mean_extinct_proba, isl_prob$mean_slope)
hist(isl_prob$mean_slope)
hist(isl_prob$mean_corr)

plot(isl_prob$mean_corr, isl_prob$mean_slope)


metric_corr <- cor(isl_prob |> dplyr::select(-c(ID, Archip)))
corrplot::corrplot(metric_corr, method = "circle")



####### Compare extinction risk with sensitivity at the species level

sp_prob <- final_vu_sp |> 
  dplyr::group_by(sci_name, S) |> 
  dplyr::summarize(VU_sp = mean(VU)) |>
  dplyr::left_join(status_trend) |>
  dplyr::filter(category!="DD")|>
  dplyr::mutate(IUCN_category = factor(
    category, levels = c("LC", "NT", "VU", "EN", "CR"), ordered = T)) |>
  dplyr::mutate(IUCN_pop_trend = factor(
    population_trend, levels = c("Increasing", "Stable", "Decreasing", "Unknown"), ordered = T)) |>
  dplyr::ungroup()


cate <- ggplot(sp_prob, aes(x=IUCN_category, y = S))+
  geom_point(aes(color=class), position = "jitter", alpha=.7, size = 2)+
  geom_boxplot(fill=NA)+xlab("IUCN extinction category")+ ylab("Species sensitivity")+
  scale_color_manual(values=c("AVES" = "#51C3CC",
                              "MAMMALIA"="#ffc44c"))+
  theme_bw()

mod1 <- lm(S~IUCN_category, data = sp_prob)
car::Anova(mod1)
ANOVA <- aov(mod1)
TukeyHSD(ANOVA)

ggplot(sp_prob, aes(x=IUCN_pop_trend, y = S))+
  geom_boxplot()+
  geom_point(position = "jitter", alpha=.2)+
  theme_bw()

mod2 <- lm(S~IUCN_pop_trend, data = sp_prob)
car::Anova(mod2)
summary(aov(mod2))


hist(sp_prob$VU_sp)
ggplot(sp_prob, aes(x=IUCN_category, y = VU_sp))+
  geom_boxplot()+
  geom_point(position = "jitter", alpha=.2)+
  theme_bw()

mod1 <- lm(VU_sp~IUCN_category, data = sp_prob)
car::Anova(mod1)
ANOVA <- aov(mod1)
TukeyHSD(ANOVA)
# not clear with final VU => mostly no signal of extinction risk on VU at species level

ggplot(sp_prob, aes(x=IUCN_pop_trend, y = VU_sp))+
  geom_boxplot()+
  geom_point(position = "jitter", alpha=.2)+
  theme_bw()
mod1 <- lm(VU_sp~IUCN_pop_trend, data = sp_prob)
car::Anova(mod1)
# nothing with population trend



####### Final figure for the article ########


pdf("figures/31_Sensitivity_x_mean_extinction.pdf", 7, 5)
sp
dev.off() 

pdf("figures/31_Sensitivity_IUCN_category.pdf", 6, 5)
cate
dev.off()



