# Get the IUCN trend of species in the checklists
# combine trends at the island level
# Compare with VU at the island level


# set packages 
# install.packages("rredlist")

# setting of the API key to access the IUCN redlist data

api_key <- "0e9cc2da03be72f04b5ddb679f769bc29834a110579ccdbeb54b79c22d3dd53d"

# Get the status trajectory for example species
rredlist::rl_history(key = api_key, name = "Pyrrhula murina")
rredlist::rl_search(key = api_key, name = "Chasiempis sandwichensis")$result


###### Load island vulnerability data #####

# load data frame in final format
data_all <- readRDS("outputs/30_all_VU_components_45_isl_266_BM_sp.rds")
# load island information and polygons
# isl <- readRDS("data/derived-data/01_shp_45_major_isl_clean.rds")
# source functions for VU calculation
source("R/Calculate_components_VU_FUN.R")

checklist <- data_all |> dplyr::select(ID:Island, sci_name)
final_vu <- vulnerabilityFUN(data_all, by_island = T)

###### Extract IUCN extinction risk for all species ######

iucn_history <- checklist |>
  dplyr::distinct(sci_name) |>
  dplyr::arrange(sci_name) |>
  dplyr::pull(sci_name) |>
  lapply(function(sci_name) {
    rredlist::rl_history(key = api_key, sci_name)$result})

names(iucn_history) <- sort(unique(checklist$sci_name))
for(i in 1:length(iucn_history)){
  iucn_history[[i]]$sp = names(iucn_history)[i]
}

# combine all species into one df
iucn_history_df <- dplyr::bind_rows(iucn_history) |>
  dplyr::select(sp, year, code) |>
  dplyr::mutate(year = as.numeric(year),
                code = as.factor(code)) |>
  dplyr::left_join(status_order, by = "code")

# check the trends for species from one island (Tristan da Cunha)
test <- iucn_history_df |> 
  dplyr::filter(sp %in% (checklist |> dplyr::filter(ID == 7725) |> dplyr::pull(sci_name)))
library(ggplot2)
ggplot(test, aes(year, order, group = sp, color = sp)) + 
  labs(y = "Extinction status level", x = "Time (year)") +
  ylim(0, 6) +
  geom_point() + geom_line()


######## Calculate trend for each island  ########

# Initialization

islands <- final_vu$ID

# Create a table with the list of status and numeric equivalent
status_order <- data.frame(
  code = c("LC","NT","VU","EN","CR","EW","EX","LR/lc","LR/nt","LR/cd","T"),
  order = c(0:6, 0, 1, 3, 3))

# Create a subset data to host results
vul_risk <- data.frame(
  ID = final_vu$ID,
  vu_sum = final_vu$VU,
  count_prop = "NA",
  cum_prop = "NA",
  mean_corr = "NA",
  mean_slope = "NA")

for (i in (1:length(islands))){
  
  # i=1
  island <- islands[i] # select the island
  final_vu$VU[which(final_vu$ID == island)] # Vulnerability value
  # get species list from the island
  sp_isl <- checklist |> dplyr::filter(ID == island) |> dplyr::pull(sci_name)
  # Filter status and years for species from the island  
  status_code <- iucn_history_df |> 
    dplyr::filter(sp %in% sp_isl)
  
  stats <- status_code |>
    # calculate extinction risk statistics
    dplyr::group_by(sp) |>
    dplyr::summarize(first_value = dplyr::first(order)) |>
    dplyr::mutate(n = dplyr::n()) |>
    dplyr::filter(first_value > 1) |>
    dplyr::summarize(sum = sum(first_value),  
            count = dplyr::n(), 
            n = max(n)) |>
    dplyr::mutate(prop = count/n, 
            cum_prop = sum/n)

  vul_risk[which(vul_risk$ID == island), "count_prop"] <- stats$prop
  vul_risk[which(vul_risk$ID == island), "cum_prop"] <- stats$cum_prop
  
  mean_slope <- status_code |>
    dplyr::group_by(sp) |>
    dplyr::group_modify(~ broom::tidy(lm(.x$order ~ .x$year))) |>
    dplyr::filter(term == ".x$year") |>
    dplyr::filter(p.value < 0.05) |>
    dplyr::ungroup() |>
    dplyr::summarize(mean_slope = mean(estimate))
  
  mean_corr <- status_code |>
    dplyr::group_by(sp) |>
    dplyr::group_modify(~ broom::tidy(cor(.x$order, .x$year, method = "spearman"))) |>
    dplyr::filter(x != "NA") |>
    dplyr::ungroup() |>
    dplyr::summarize(mean_corr = mean(x))
  
  vul_risk[which(vul_risk$ID == island), "mean_corr"] <- mean_corr$mean_corr
  vul_risk[which(vul_risk$ID == island), "mean_slope"] <- mean_slope$mean_slope

}

saveRDS(vul_risk, "outputs/31_validation_risk_redlist.rds")

# Quick and dirty analyses

vul_risk <- readRDS("outputs/31_validation_risk_redlist.rds") |>
  dplyr::as_tibble() |>
  dplyr::mutate(count_prop = as.numeric(count_prop)) |>
  dplyr::mutate(cum_prop = as.numeric(cum_prop)) |>
  dplyr::mutate(mean_corr = as.numeric(mean_corr)) |>
  dplyr::mutate(mean_slope = as.numeric(mean_slope)) |> 
  dplyr::left_join(data_all |> dplyr::distinct(ID, Archip, Island))


archip_col <-  c(
  "Galapagos Islands" = "#4DAF4A",
  "Canary Islands" = "#377EB8",
  "Azores"="#FF7F00", 
  "Mascarene Islands" = "#984EA3",
  "Hawaii" = "#E41A1C",
  "Tristan da Cunha Islands" = "#B15928")

ggplot(vul_risk, aes(count_prop, vu_sum, group = Archip, color = Archip)) +
  labs(y = "Vulnerability score", x = "Proportion of threatened species") +
  geom_point()+
  scale_color_manual(values = archip_col)+
  theme_bw()

summary(lm(vu_sum ~ count_prop+Archip, data = vul_risk))

cor(vul_risk$vu_sum, vul_risk$count_prop, use = "complete.obs")


ggplot(vul_risk, aes(mean_corr, vu_sum, group = Archip, color = Archip)) +
  labs(y = "Vulnerability score", x = "Spearman correlation over time") +
  geom_point()+
  scale_color_manual(values = archip_col)+
  theme_bw()

summary(lm(vu_sum ~ mean_corr, data = vul_risk))





####### Simpler method: mean species' extinction probability #######


all_sp <- unique(checklist$sci_name)
status_trend_df <- data.frame()
for(i in 1:length(all_sp)){
  status_trend_sp <- rredlist::rl_search(key = api_key, all_sp[i])$result
  status_trend_df <- dplyr::bind_rows(status_trend_df, status_trend_sp)
  print(i)
}


summary(as.factor(status_trend_df$population_trend))
summary(as.factor(status_trend_df$category))

status_trend <- status_trend_df |>
  dplyr::rename(sci_name = scientific_name)|>
  dplyr::select(sci_name, category, population_trend)

# Give a probability of extinction to each IUCN category (Moers et al 2008)
pCR <- 0.97
proba <- data.frame(category = c("LC", "NT", "VU", "EN", "CR"),
                 p = c(pCR/16, pCR/8, pCR/4, pCR/2, pCR))

# proba per island 

isl_prob <- checklist |>
  dplyr::left_join(status_trend, by ="sci_name") |>
  dplyr::left_join(proba, by = "category")|>
  dplyr::group_by(ID, Archip) |>
  dplyr::summarise(mean_extinct_proba = mean(p, na.rm = T),
                   sd_extinct_proba = sd(p, na.rm = T)) |>
  dplyr::left_join(final_vu, by = "ID") |>
  dplyr::left_join(vul_risk |> dplyr::select(ID, count_prop:mean_slope), by="ID")|>
  dplyr::ungroup()


ggplot(isl_prob, aes(mean_extinct_proba, VU, group = Archip, color = Archip)) +
  labs(y = "Vulnerability score", x = "Mean probability of extinction") +
  geom_point()+
  scale_color_manual(values = archip_col)+
  theme_bw()

summary(lm(VU ~ mean_extinct_proba, data = isl_prob))


ggplot(isl_prob, aes(mean_extinct_proba, S, group = Archip, color = Archip)) +
  labs(y = "Sensitivity", x = "Mean probability of extinction") +
  geom_point()+
  scale_color_manual(values = archip_col)+
  theme_bw()

ggplot(isl_prob, aes(mean_extinct_proba, AC, group = Archip, color = Archip)) +
  labs(y = "Adaptive capacity", x = "Mean probability of extinction") +
  geom_point()+
  scale_color_manual(values = archip_col)+
  theme_bw()


ggplot(isl_prob, aes(mean_extinct_proba, E, group = Archip, color = Archip)) +
  labs(y = "Exposure", x = "Mean probability of extinction") +
  geom_point()+
  scale_color_manual(values = archip_col)+
  theme_bw()


cor.test(isl_prob$mean_extinct_proba, isl_prob$E)
cor.test(isl_prob$mean_extinct_proba, isl_prob$S)
cor.test(isl_prob$mean_extinct_proba, isl_prob$AC)
cor.test(isl_prob$mean_extinct_proba, isl_prob$VU)


plot(isl_prob$mean_extinct_proba, isl_prob$count_prop)
cor.test(isl_prob$mean_extinct_proba, isl_prob$count_prop)
plot(isl_prob$mean_extinct_proba, isl_prob$cum_prop)
# the two metrics are very similar


plot(isl_prob$mean_extinct_proba, isl_prob$mean_corr)
plot(isl_prob$mean_extinct_proba, isl_prob$mean_slope)
hist(isl_prob$mean_slope)
hist(isl_prob$mean_corr)

plot(isl_prob$mean_corr, isl_prob$mean_slope)


metric_corr <- cor(isl_prob |> dplyr::select(-c(ID, Archip)))
corrplot::corrplot(metric_corr, method = "circle")

