# Vulnerability 

rm(list = ls())

library(tidyverse)

# load exposure
expo_all <- readRDS("data/derived-data/23_Exposure_major_isl.rds")

# load sensitivity
s_all <- readRDS("data/derived-data/15_Sensitivity_BMP_major_isl.rds")

# load adaptive capacity
ac_all <- readRDS("data/derived-data/32_AC_tot_BMP_major_isl.rds")

# define positive and negative ideal solution for TOPSIS method
sol <- data.frame(
  Exposure = c(0, 1),
  Sensitivity = c(0, 1),
  AdaptCapacity = c(1, 0))
rownames(sol) <- c("pos", "neg")


# define a function to compute vulnerability
# input: the normalization method and the taxon 
# output: a dataframe with island classic biogeo var + VU values + VU ranks

calc.vu <- function(norm.method, taxon){
  
  # normalization method must be max_min, rank, or log
  if(!norm.method %in% c("log", "rank", "max_min")) stop("Normalization method is rank, log, or max_min")
  # taxon must be bird, mam or plant
  if(!taxon %in% c("bird", "mam", "plant")) stop("Taxon in bird, mam, or plant")
  
  tax <- paste0("_", taxon)
  norma <- norm.method
  
  # select data accordingly
  expo <- expo_all[[paste0("th_", norma)]] %>%
    select(ID, expo:Lat)
  sensit <- s_all[[paste0("s_", norma)]] %>%
    select(ID, contains(tax))
  names(sensit) <- c("ID","sens", "SR")
  ac <- ac_all[[paste0("ac_", norma)]] %>% 
    select(ID, contains(tax))
  names(ac) <- c("ID","AC")
  
  
  compo <- left_join(expo, left_join(sensit, ac)) 
  
  compo <- compo %>%
    # normalize final components
    mutate(Exposure01 = (expo-min(compo$expo, na.rm = T))/
             (max(compo$expo, na.rm = T)-min(compo$expo, na.rm = T)),
           Sensitivity01 = (sens-min(compo$sens, na.rm = T))/
             (max(compo$sens, na.rm = T)-min(compo$sens, na.rm = T)),
           AdaptCapacity01 = (AC-min(compo$AC, na.rm = T))/
             (max(compo$AC, na.rm = T)-min(compo$AC, na.rm = T))) %>%
    # Calculate VU = E+S-AC and rank isl (which ref?)
    mutate(Vu_sum = Exposure01 + Sensitivity01 - AdaptCapacity01) %>%
    mutate(Vu_rank_sum = dense_rank(Vu_sum)) %>%
    # Calculate TOPSIS VU and rank isl (Leclerc et al 2020)
    mutate(
      pos_sol = ((Exposure01-sol[1,1])^2 + (Sensitivity01-sol[1,2])^2 + (AdaptCapacity01-sol[1,3])^2)^0.5,
      neg_sol = ((Exposure01-sol[2,1])^2 + (Sensitivity01-sol[2,2])^2 + (AdaptCapacity01-sol[2,3])^2)^0.5,
    ) %>%
    mutate(Vu_TOPSIS = pos_sol / (pos_sol + neg_sol)) %>%
    mutate(Vu_rank_TOPSIS = dense_rank(Vu_TOPSIS)) %>%
    # calculate VU = E*S/(1+AC) (Butt et al 2022)
    mutate(Vu_prod = Exposure01*Sensitivity01/(AdaptCapacity01+1)) %>%
    mutate(Vu_rank_prod = dense_rank(Vu_prod))
  
  return(compo)
  
}

# function to save the output of calc.vu
save.vu <- function(norm.method, taxon){
  compo <- calc.vu(norm.method, taxon)
  saveRDS(compo, paste0("outputs/40_Vulnerability_", taxon, "_", norm.method, ".rds"))
}

# save VU for birds, mammals
save.vu(norm.method = "log", taxon = "mam")
save.vu(norm.method = "max_min", taxon = "mam")
save.vu(norm.method = "rank", taxon = "mam")
save.vu(norm.method = "log", taxon = "bird")
save.vu(norm.method = "max_min", taxon = "bird")
save.vu(norm.method = "rank", taxon = "bird")



# test method
group = "mam"
norm = "max_min"

compo <- calc.vu(norm, group)


plot(compo$expo, compo$Exposure01)
plot(compo$sens, compo$Sensitivity01)
plot(compo$AC, compo$AdaptCapacity01)


# plot VU with island polygons


# Get island polygons
path_data <- "Z:/THESE/5_Data/Distribution_spatiale/"
gadm_islands <- sf::st_read(paste0(
  path_data, "Shpfiles_iles_continent/Islands_Weigelt_reparees.shp"))

vu.b <- calc.vu("max_min","bird")
shp.vu <- left_join(vu.b, gadm_islands, by = join_by(ID==ULM_ID)) %>% sf::st_as_sf()


# Min and max values across all islands for color scale
max.vu <- max(vu.b$Vu_sum, na.rm = T)
min.vu <- min(vu.b$Vu_sum, na.rm = T)

#devtools::install_github('oswaldosantos/ggsn')


world <- map_data("world")
pdf("figures/world.pdf",10,7)
ggplot(world)+
  geom_map(data = world, map = world,
  aes(long, lat, map_id = region),
  color = NA, fill = "grey70") + theme_void()
dev.off()

a <- ggplot(shp.vu %>% filter(Archip=="Azores"))+
  geom_sf(aes(fill=Vu_sum), color = "grey70")+
  geom_text(aes(x=LONG, y = LAT, label = SR), color = "black") + 
  scale_fill_gradientn(colors = viridis::viridis_pal(option = "H")(7), 
                       limits=c(min.vu, max.vu), 
                       na.value = "grey70")+ 
  ggsn::blank() +
  ggsn::north(shp.vu %>% filter(Archip=="Azores"), symbol = 10) +
  ggsn::scalebar(shp.vu %>% filter(Archip=="Azores"), dist = 100, dist_unit = "km",
           transform = TRUE, model = "WGS84", location = "bottomleft", 
           st.dist = .05, border.size = .5, st.bottom = F)+
  theme(panel.background = element_rect(fill = "white", colour = "grey50"),
        panel.grid.major = element_line(colour = "lightgrey"))
a
c <- ggplot(shp.vu %>% filter(Archip=="Canary Islands"))+
  geom_sf(aes(fill=Vu_sum), color = "grey70")+
  geom_text(aes(x=LONG, y = LAT, label = SR), color = "black") + 
  scale_fill_gradientn(colors = viridis::viridis_pal(option = "H")(7), 
                       limits=c(min.vu, max.vu), 
                       na.value = "grey70")+ 
  ggsn::blank() +
  ggsn::scalebar(shp.vu %>% filter(Archip=="Canary Islands"), dist = 100, dist_unit = "km",
                 transform = TRUE, model = "WGS84", 
                 location = "topleft", st.dist = .06, border.size = .5, st.bottom = F)+
  theme(panel.background = element_rect(fill ="white", colour = "grey50"),
        panel.grid.major = element_line(colour = "lightgrey"))
c
g <- ggplot(shp.vu %>% filter(Archip=="Galapagos Islands"))+
  geom_sf(aes(fill=Vu_sum), color = "grey70")+
  geom_text(aes(x=LONG, y = LAT, label = SR), color = "black") + 
  scale_fill_gradientn(colors = viridis::viridis_pal(option = "H")(7), 
                       limits=c(min.vu, max.vu), 
                       na.value = "grey70")+ 
  ggsn::blank() +
  ggsn::scalebar(shp.vu %>% filter(Archip=="Galapagos Islands"), dist = 100, dist_unit = "km",
                 transform = TRUE, model = "WGS84", 
                 location = "topright", st.dist = .04, border.size = .5, st.bottom = F)+
  theme(panel.background = element_rect(fill ="white", colour = "grey50"),
        panel.grid.major = element_line(colour = "lightgrey"))
g
h <- ggplot(shp.vu %>% filter(Archip=="Hawaii"))+
  geom_sf(aes(fill=Vu_sum), color = "grey70")+
  geom_text(aes(x=LONG, y = LAT, label = SR), color = "black") + 
  scale_fill_gradientn(colors = viridis::viridis_pal(option = "H")(7), 
                       limits=c(min.vu, max.vu), 
                       na.value = "grey70")+ 
  ggsn::blank() +
  #ggsn::north(shp.vu %>% filter(Archip=="Hawaii"), symbol = 10) +
  ggsn::scalebar(shp.vu %>% filter(Archip=="Hawaii"), dist = 100, dist_unit = "km",
                 transform = TRUE, model = "WGS84", 
                 location = "bottomleft", st.dist = .04, border.size = .5, st.bottom = F)+
  theme(panel.background = element_rect(fill = "white", colour = "grey50"),
        panel.grid.major = element_line(colour = "lightgrey"))


h 
m <- ggplot(shp.vu %>% filter(Archip=="Mascarene Islands"))+
  geom_sf(aes(fill=Vu_sum), color = "grey70")+
  geom_text(aes(x=LONG, y = LAT, label = SR), color = "black") + 
  scale_fill_gradientn(colors = viridis::viridis_pal(option = "H")(7), 
                       limits=c(min.vu, max.vu), 
                       na.value = "grey70")+
  #ggsn::north(shp.vu %>% filter(Archip=="Mascarene Islands"), symbol = 10) +
  ggsn::scalebar(shp.vu %>% filter(Archip=="Mascarene Islands"), dist = 100, dist_unit = "km",
                 transform = TRUE, model = "WGS84", location = "bottomright", 
                 height = .05, st.dist = .06, border.size = .5, st.bottom = F)+
  ggsn::blank()+
  theme(panel.background = element_rect(fill = "white", colour = "grey50"),
        panel.grid.major = element_line(colour = "lightgrey"))
m

pdf("figures/Map_VU_birds.pdf",10,7)
ggpubr::ggarrange(a, c, g, h, m, nrow = 2, ncol = 3, legend = "none" )
dev.off()
pdf("figures/Map_VU_birds_legend.pdf",10,7)
a
dev.off()


a
pdf("figures/Map_VU_mam.pdf",10,7)
ggpubr::ggarrange(a, c, g, h, m, nrow = 2, ncol = 3, legend = "none" )
dev.off()

theme_minimal()


###### Parallel coordinate plot ######

# install.packages("GGally")
# data <- iris


shp.vu.nona <- shp.vu %>% mutate(Archip = as.factor(Archip)) %>%
  filter(!is.na(Exposure01))%>% 
  sf::st_drop_geometry() %>%
  dplyr::select(Archip, Exposure01:AdaptCapacity01)


GGally::ggparcoord(data = shp.vu.nona,
    columns = 2:4, 
    scale="globalminmax",
    groupColumn = 1, 
    showPoints = TRUE,
    order = "anyClass",
    title = "Parallel Coordinate Plot",
    alphaLines = 1) +
  scale_color_manual(values = c(
    "Galapagos Islands" = "#4DAF4A",
    "Canary Islands" = "#377EB8",
    "Azores"="#FF7F00", 
    "Mascarene Islands" = "#984EA3",
    "Hawaii" = "#E41A1C"))+
  theme_bw()

####### Separate metric components #######

calc.metrics <- function(norm.method, taxon){
  
  # normalization method must be max_min, rank, or log
  if(!norm.method %in% c("log", "rank", "max_min")) stop("Normalization method is rank, log, or max_min")
  # taxon must be bird, mam or plant
  if(!taxon %in% c("bird", "mam", "plant")) stop("Taxon in bird, mam, or plant")
  
  norma <- norm.method
  
  # select data accordingly
  expo <- expo_all[[paste0("th_", norma)]] %>%
    select(ID, lu, cc, ias, Island_name: Lat)
  
  if(taxon=="mam"){
    sensit <- readRDS("data/derived-data/13_Sensitivity_mam_major_isl.rds")[[paste0("sm_", norma)]]
    ac <- ac_all[[paste0("ac_", norma)]] %>% 
      select(ID:mass)
  }
  if(taxon=="bird"){
    sensit <- readRDS("data/derived-data/13_Sensitivity_bird_major_isl.rds")[[paste0("sb_", norma)]]
    ac <- ac_all[[paste0("ac_", norma)]] %>% 
      select(ID:PA_prop, mean_hwi)
  }
  
  compo <- left_join(expo, left_join(sensit, ac)) 
  return(compo)
  
}

bird <- calc.metrics("max_min","bird")
mam <- calc.metrics("max_min","mam")

metricsb <- bird %>% 
  mutate(Archip = as.factor(Archip)) %>%
  filter(!is.na(ias))%>%
  dplyr::select(Archip, lu, cc, ias, restricted_range, diet_specialism,
  hab_specialism, GenLength, mean_tri, mean_elev, PA_prop, mean_hwi)

colnames(bird)

metricsm <- mam %>% 
  mutate(Archip = as.factor(Archip)) %>%
  filter(!is.na(ias))%>%
  dplyr::select(Archip, lu, cc, ias, restricted_range, diet_specialism,
                hab_specialism, generation_length_d, mean_tri, mean_elev, PA_prop, mass)



plot.par.coord <- function(metrics){
  GGally::ggparcoord(data = metrics,
                   columns = 2:ncol(metrics), 
                   scale="globalminmax",
                   groupColumn = 1, 
                   showPoints = TRUE,
                   order = c(2:ncol(metrics)),
                   alphaLines = 0.3) +
  scale_color_manual(values = c(
    "Galapagos Islands" = "#4DAF4A",
    "Canary Islands" = "#377EB8",
    "Azores"="#FF7F00", 
    "Mascarene Islands" = "#984EA3",
    "Hawaii" = "#E41A1C"))+
  theme_bw()+
    facet_wrap(~Archip, nrow = 3, ncol = 2)+
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none",
        strip.background = element_rect(colour="grey30",fill= NA))
  }



colnames(metricsb)
colnames(metricsm)

newnames <- c("Archip", "Land-use change", "Climate change", "Biological invasions",
              "Restricted range size", "Diet specialism", "Habitat specialism",
              "Generation length", "Terrain ruggedness", "Elevation", 
              "Protected areas", "Dispersal ability")
colnames(metricsb) <- colnames(metricsm) <- newnames

pdf("figures/Metrics_parallel_birds.pdf",8,7)
plot.par.coord(metricsb)
dev.off()

pdf("figures/Metrics_parallel_mam.pdf",8,7)
plot.par.coord(metricsm)
dev.off()

plot.par.coord(metricsb)
plot.par.coord(metricsm)

# for WS slides 
png("figures/Metrics_parallel_mam.png",
    width = 25, height = 14, units = "cm", res = 300)
plot.par.coord(metricsm)+facet_wrap(~Archip, nrow = 2, ncol = 3)
dev.off()
png("figures/Metrics_parallel_bird.png",
    width = 25, height = 14, units = "cm", res = 300)
plot.par.coord(metricsb)+facet_wrap(~Archip, nrow = 2, ncol = 3)
dev.off()

# Mammals and birds in the same plot

metrics_all <- bind_rows(
  metricsb %>% mutate(Group = "Aves"),
  metricsm %>% mutate(Group = "Mammalia")
) %>% mutate(Archip = as.character(Archip))


to_string <- as_labeller(c(`1` = "Azores", 
                           `2` = "Canary Islands",
                           `3` = "Galapagos Islands",
                           `4` = "Hawaii",
                           `5` = "Mascarene Islands"))

mam_birds <- GGally::ggparcoord(data = metrics_all,
                                columns = 2:12, 
                                scale="globalminmax",
                                groupColumn = 13, 
                                showPoints = TRUE,
                                order = c(2:12),
                                alphaLines = 0.8) +
  scale_color_manual(values = c(
    "Aves" = "#51C3CC",
    "Mammalia"="#ffc44c"))+
  geom_point(alpha = .5)+ geom_line(alpha = .5 )+
  theme_bw()+
  facet_wrap(~Archip, nrow = 3, ncol = 2, labeller = to_string)+
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "none",
        strip.background = element_rect(colour="grey30",fill= NA))


pdf("figures/Metrics_parallel_BM.pdf",8,7)
mam_birds
dev.off()

# for WS slides 
png("figures/Metrics_parallel_BM.png",
    width = 25, height = 14, units = "cm", res = 300)
mam_birds+facet_wrap(~Archip, nrow = 2, ncol = 3, labeller = to_string)
dev.off()

#test grouping the taxa
# geom_line(aes(alpha = Group))+
#   geom_point(aes(shape = Group))+
#   scale_alpha_binned()+
#   scale_shape_binned()+




#### relationships between VU methods ####

# Sum and TOPSIS

ggplot(compo) +
  geom_smooth(aes(x=Vu_sum, y = Vu_TOPSIS), method = "lm")+
  geom_point(aes(x=Vu_sum, y = Vu_TOPSIS, color = Archip))+
  theme_classic()
# perfectly correlated, almost linear 1:1
cor.test(compo$Vu_sum, compo$Vu_TOPSIS)  # r = 0.9957 for max_min bird

ggplot(compo)+
  geom_abline(slope = 1, intercept = 0, lty=2, color = "grey")+
  geom_line(aes(x=Vu_rank_sum, y = Vu_rank_TOPSIS))+
  geom_point(aes(x=Vu_rank_sum, y = Vu_rank_TOPSIS, color = Archip))+
  theme_classic()
# almost the same final ranking


# sum and product

ggplot(compo) +
  #geom_smooth(aes(x=Vu_sum, y = Vu_prod), method = "lm")+
  geom_point(aes(x=Vu_sum, y = Vu_prod, color = Archip))+
  theme_classic()
# also highly correlated
cor.test(compo$Vu_sum, compo$Vu_prod)  # r = 0.8339

ggplot(compo)+
  geom_abline(slope = 1, intercept = 0, lty=2, color = "grey")+
  geom_line(aes(x=Vu_rank_sum, y = Vu_rank_prod))+
  geom_point(aes(x=Vu_rank_sum, y = Vu_rank_prod, color = Archip))+
  theme_classic()
# ranking is very different, especially for low and intermediate values of Vu


##### VU = E + S - AC ####

# expo and sensit
es <- ggplot(compo)+
  geom_hline(yintercept = .5, lty=2, color="grey")+
  geom_vline(xintercept = .5, lty=2, color="grey")+
  geom_point(aes(x=Exposure01, y = Sensitivity01, size = Area, 
                 color = Vu_sum), alpha = .5)+
  viridis::scale_color_viridis()+
  theme_classic()

# expo and ac
ea <- ggplot(compo)+
  geom_hline(yintercept = .5, lty=2, color="grey")+
  geom_vline(xintercept = .5, lty=2, color="grey")+
  geom_point(aes(x=Exposure01, y = AdaptCapacity01, size = Area, 
                 color = Vu_sum), alpha = .5)+
  viridis::scale_color_viridis()+
  theme_classic()

# sensi and ac
sa <- ggplot(compo)+
  geom_hline(yintercept = .5, lty=2, color="grey")+
  geom_vline(xintercept = .5, lty=2, color="grey")+
  geom_point(aes(x=Sensitivity01, y = AdaptCapacity01, size = Area, 
                 color = Vu_sum), alpha = .5)+
  viridis::scale_color_viridis()+
  theme_classic()

ggpubr::ggarrange(es, ea, sa, nrow=1, ncol = 3, common.legend = T, legend = "bottom")


# Vulnerability ranking
rk <- ggplot(compo)+
  geom_bar(aes(x=as.factor(-Vu_rank_sum), y = Vu_sum, fill = Archip),
           stat = "identity", color="white") +
    coord_flip()+
  theme_classic()+
  theme(axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(), 
        axis.line.y = element_blank())+
  ylab("Vulnerability")+xlab("")+
  scale_fill_manual(values = c(
    "Galapagos Islands" = "#4DAF4A",
    "Canary Islands" = "#377EB8",
    "Azores"="#FF7F00", 
    "Mascarene Islands" = "#984EA3",
    "Hawaii" = "#E41A1C"))

RColorBrewer::brewer.pal(name = "Set1", n=9)

# VU final by archip
ggplot(compo)+
  geom_boxplot(aes(x=Archip, y = Vu_sum))+
  geom_point(aes(x=Archip, y = Vu_sum, size = Area, color = Archip), 
             position = 'jitter', alpha = .5)+
  theme_classic()

# VU components by archip

compo_lg <- compo %>%
  mutate(AdaptCapacity01 = -AdaptCapacity01) %>%
  pivot_longer(cols = Exposure01:AdaptCapacity01,
               names_to = "Metric",
               values_to = "Value")
compo_mean <- compo_lg %>%
  group_by(Archip, Metric) %>%
  summarize(mean = mean(Value, na.rm = T),
            sd = sd(Value, na.rm=T)) %>%
  mutate(Metric = factor(
    Metric, ordered = T, 
    levels = c("Exposure01", "Sensitivity01","AdaptCapacity01")))

ggplot(compo_lg)+
  geom_boxplot(aes(x=Archip, y = Value, fill = Metric))


bar <- ggplot(compo_mean, 
       aes(x=Archip, y = mean, ymin = mean-sd, ymax=mean+sd, fill = Metric)) + 
  geom_bar(position = position_dodge(), stat="identity", color = "white")  +
  geom_errorbar(position=position_dodge(.9), width = .3, color = "grey60")+
  theme_classic()+
  theme(axis.text.x = element_blank())+
  viridis::scale_fill_viridis(begin = 0.1, end = 0.9, discrete = T)


ggpubr::ggarrange(rk, bar, nrow = 2, ncol = 1)


pdf(paste0("figures/40_VU_rang_compo_", norm, "_", group, ".pdf"), 3, 5)
ggpubr::ggarrange(rk, bar, nrow = 2, ncol = 1, legend = "none")
dev.off()

pdf("figures/40_VU_rang_compo_legend.pdf", 5, 5)
ggpubr::ggarrange(rk, bar, nrow = 2, ncol = 1)
dev.off()

###### Effect of normalisation method on ranking #######
group = "bird"
maxmin <- calc.vu("max_min", group)
log <- calc.vu("log", group)
rank <- calc.vu("rank", group)


# final VU, formula = VU1
plot(maxmin$Vu_rank_sum, log$Vu_rank_sum)
plot(maxmin$Vu_rank_sum, rank$Vu_rank_sum)
plot(rank$Vu_rank_sum, log$Vu_rank_sum)

# Exposure
plot(maxmin$Exposure01, log$Exposure01)
plot(maxmin$Exposure01, rank$Exposure01)
plot(rank$Exposure01, log$Exposure01)

# Sensitivity
plot(maxmin$Sensitivity01, log$Sensitivity01)
plot(maxmin$Sensitivity01, rank$Sensitivity01)
plot(rank$Sensitivity01, log$Sensitivity01)

# Adaptive Capacity
plot(maxmin$AdaptCapacity01, log$AdaptCapacity01)
plot(maxmin$AdaptCapacity01, rank$AdaptCapacity01)
plot(rank$AdaptCapacity01, log$AdaptCapacity01)

