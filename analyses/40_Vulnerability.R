# Vulnerability 

rm(list = ls())

library(tidyverse)

# load exposure
expo_all <- readRDS("data/derived-data/23_Exposure_major_isl.rds")

# load sensitivity
s_all <- readRDS("data/derived-data/15_Sensitivity_BMP_major_isl.rds")

# load adaptive capacity
ac_all <- readRDS("data/derived-data/32_AC_tot_BMP_major_isl.rds")

# define positive and negative ideal solution for TOPSIS method
sol <- data.frame(
  Exposure = c(0, 1),
  Sensitivity = c(0, 1),
  AdaptCapacity = c(1, 0))
rownames(sol) <- c("pos", "neg")


# define a function to compute vulnerability
# input: the normalization method and the taxon 
# output: a dataframe with island classic biogeo var + VU values + VU ranks

calc.expo <- function(norm.method, taxon){
  
  # normalization method must be max_min, rank, or log
  if(!norm.method %in% c("log", "rank", "max_min")) stop("Normalization method is rank, log, or max_min")
  # taxon must be bird, mam or plant
  if(!taxon %in% c("bird", "mam", "plant")) stop("Taxon in bird, mam, or plant")
  
  tax <- paste0("_", taxon)
  norma <- norm.method
  
  # select data accordingly
  expo <- expo_all[[paste0("th_", norma)]] %>%
    select(ID, expo:Lat)
  sensit <- s_all[[paste0("s_", norma)]] %>%
    select(ID, contains(tax))
  names(sensit) <- c("ID","sens", "SR")
  ac <- ac_all[[paste0("ac_", norma)]] %>% 
    select(ID, contains(tax))
  names(ac) <- c("ID","AC")
  
  
  compo <- left_join(expo, left_join(sensit, ac)) 
  
  compo <- compo %>%
    # normalize final components
    mutate(Exposure01 = (expo-min(compo$expo, na.rm = T))/
             (max(compo$expo, na.rm = T)-min(compo$expo, na.rm = T)),
           Sensitivity01 = (sens-min(compo$sens, na.rm = T))/
             (max(compo$sens, na.rm = T)-min(compo$sens, na.rm = T)),
           AdaptCapacity01 = (AC-min(compo$AC, na.rm = T))/
             (max(compo$AC, na.rm = T)-min(compo$AC, na.rm = T))) %>%
    # Calculate VU = E+S-AC and rank isl (which ref?)
    mutate(Vu_sum = Exposure01 + Sensitivity01 - AdaptCapacity01) %>%
    mutate(Vu_rank_sum = dense_rank(Vu_sum)) %>%
    # Calculate TOPSIS VU and rank isl (Leclerc et al 2020)
    mutate(
      pos_sol = ((Exposure01-sol[1,1])^2 + (Sensitivity01-sol[1,2])^2 + (AdaptCapacity01-sol[1,3])^2)^0.5,
      neg_sol = ((Exposure01-sol[2,1])^2 + (Sensitivity01-sol[2,2])^2 + (AdaptCapacity01-sol[2,3])^2)^0.5,
    ) %>%
    mutate(Vu_TOPSIS = pos_sol / (pos_sol + neg_sol)) %>%
    mutate(Vu_rank_TOPSIS = dense_rank(Vu_TOPSIS)) %>%
    # calculate VU = E*S/(1+AC) (Butt et al 2022)
    mutate(Vu_prod = Exposure01*Sensitivity01/(AdaptCapacity01+1)) %>%
    mutate(Vu_rank_prod = dense_rank(Vu_prod))
  
  return(compo)
  
}

# function to save the output of calc_expo
save.vu <- function(norm.method, taxon){
  compo <- calc.expo(norm.method, taxon)
  saveRDS(compo, paste0("outputs/40_Vulnerability_", taxon, "_", norm.method, ".rds"))
}

# save VU for birds, mammals
save.vu(norm.method = "log", taxon = "mam")
save.vu(norm.method = "max_min", taxon = "mam")
save.vu(norm.method = "rank", taxon = "mam")
save.vu(norm.method = "log", taxon = "bird")
save.vu(norm.method = "max_min", taxon = "bird")
save.vu(norm.method = "rank", taxon = "bird")



# test method
compo <- calc.expo("log", "bird")


plot(compo$expo, compo$Exposure01)
plot(compo$sens, compo$Sensitivity01)
plot(compo$AC, compo$AdaptCapacity01)


#### relationships between VU methods ####

# Sum and TOPSIS

ggplot(compo) +
  geom_smooth(aes(x=Vu_sum, y = Vu_TOPSIS), method = "lm")+
  geom_point(aes(x=Vu_sum, y = Vu_TOPSIS, color = Archip))+
  theme_classic()
# perfectly correlated, almost linear 1:1
cor.test(compo$Vu_sum, compo$Vu_TOPSIS)  # r = 0.9957 for max_min bird

ggplot(compo)+
  geom_abline(slope = 1, intercept = 0, lty=2, color = "grey")+
  geom_line(aes(x=Vu_rank_sum, y = Vu_rank_TOPSIS))+
  geom_point(aes(x=Vu_rank_sum, y = Vu_rank_TOPSIS, color = Archip))+
  theme_classic()
# almost the same final ranking


# sum and product

ggplot(compo) +
  #geom_smooth(aes(x=Vu_sum, y = Vu_prod), method = "lm")+
  geom_point(aes(x=Vu_sum, y = Vu_prod, color = Archip))+
  theme_classic()
# also highly correlated
cor.test(compo$Vu_sum, compo$Vu_prod)  # r = 0.8339

ggplot(compo)+
  geom_abline(slope = 1, intercept = 0, lty=2, color = "grey")+
  geom_line(aes(x=Vu_rank_sum, y = Vu_rank_prod))+
  geom_point(aes(x=Vu_rank_sum, y = Vu_rank_prod, color = Archip))+
  theme_classic()
# ranking is very different, especially for low and intermediate values of Vu


##### VU = E + S - AC ####

# expo and sensit
es <- ggplot(compo)+
  geom_hline(yintercept = .5, lty=2, color="grey")+
  geom_vline(xintercept = .5, lty=2, color="grey")+
  geom_point(aes(x=Exposure01, y = Sensitivity01, size = Area, 
                 color = Vu_sum), alpha = .5)+
  viridis::scale_color_viridis()+
  theme_classic()

# expo and ac
ea <- ggplot(compo)+
  geom_hline(yintercept = .5, lty=2, color="grey")+
  geom_vline(xintercept = .5, lty=2, color="grey")+
  geom_point(aes(x=Exposure01, y = AdaptCapacity01, size = Area, 
                 color = Vu_sum), alpha = .5)+
  viridis::scale_color_viridis()+
  theme_classic()

# sensi and ac
sa <- ggplot(compo)+
  geom_hline(yintercept = .5, lty=2, color="grey")+
  geom_vline(xintercept = .5, lty=2, color="grey")+
  geom_point(aes(x=Sensitivity01, y = AdaptCapacity01, size = Area, 
                 color = Vu_sum), alpha = .5)+
  viridis::scale_color_viridis()+
  theme_classic()

ggpubr::ggarrange(es, ea, sa, nrow=1, ncol = 3, common.legend = T, legend = "bottom")


# Vulnerability ranking
ggplot(compo)+
  geom_bar(aes(x=as.factor(-Vu_rank_sum), y = Vu_sum,
               fill = Archip), stat = "identity", color="white")+
  theme(axis.text.x = element_blank()) +
    coord_flip()+
  theme_classic()


# VU final by archip
ggplot(compo)+
  geom_boxplot(aes(x=Archip, y = Vu_sum))+
  geom_point(aes(x=Archip, y = Vu_sum, size = Area, color = Archip), 
             position = 'jitter', alpha = .5)+
  theme_classic()











